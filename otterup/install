#!/usr/bin/env bash
set -e

# Otterup bootstrap installer
# Downloads otterup script and sets up PATH

INSTALL_DIR="${OTTER_DIR:-$HOME/.otter}"
BIN_DIR="$INSTALL_DIR/bin"
OTTERUP_URL="https://raw.githubusercontent.com/your-org/otterevm/main/otterup/otterup"

# Color output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info() {
    echo -e "${GREEN}info${NC}: $1"
}

warn() {
    echo -e "${YELLOW}warn${NC}: $1"
}

# Detect shell and config file
get_shell_config() {
    local shell_name=$(basename "$SHELL")

    case "$shell_name" in
        zsh)
            if [[ -n "$ZDOTDIR" ]]; then
                echo "$ZDOTDIR/.zshenv"
            else
                echo "$HOME/.zshenv"
            fi
            ;;
        bash)
            echo "$HOME/.bashrc"
            ;;
        fish)
            echo "$HOME/.config/fish/config.fish"
            ;;
        *)
            echo "$HOME/.profile"
            ;;
    esac
}

main() {
    echo "Installing otterup..."
    echo ""

    # Create bin directory
    mkdir -p "$BIN_DIR"

    # Download otterup script
    info "Downloading otterup script..."
    if command -v curl >/dev/null 2>&1; then
        curl -# -L "$OTTERUP_URL" -o "$BIN_DIR/otterup"
    elif command -v wget >/dev/null 2>&1; then
        wget --show-progress -q -O "$BIN_DIR/otterup" "$OTTERUP_URL"
    else
        echo "Error: Neither curl nor wget found. Please install one of them."
        exit 1
    fi

    chmod +x "$BIN_DIR/otterup"
    info "Otterup installed to $BIN_DIR/otterup"

    # Add to PATH if not already present
    if [[ ":$PATH:" != *":$BIN_DIR:"* ]]; then
        SHELL_CONFIG=$(get_shell_config)
        SHELL_NAME=$(basename "$SHELL")

        info "Adding $BIN_DIR to PATH in $SHELL_CONFIG"
        echo ""

        mkdir -p "$(dirname "$SHELL_CONFIG")"

        echo "" >> "$SHELL_CONFIG"
        echo "# Added by otterup installer" >> "$SHELL_CONFIG"

        if [[ "$SHELL_NAME" == "fish" ]]; then
            echo "fish_add_path -a \"$BIN_DIR\"" >> "$SHELL_CONFIG"
        else
            echo "export PATH=\"$BIN_DIR:\$PATH\"" >> "$SHELL_CONFIG"
        fi

        echo ""
        warn "Please restart your shell or run:"
        echo "  source $SHELL_CONFIG"
        echo ""
    fi

    # Run otterup to install otter binary
    info "Running otterup to install otter..."
    echo ""

    export PATH="$BIN_DIR:$PATH"
    "$BIN_DIR/otterup"
}

main
